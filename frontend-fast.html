<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="NexusAI - Intelligent Conversations">
  <title>NovaKB - Intelligent Conversations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    :root {
      --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #667eea 75%, #764ba2 100%);
      --bg-secondary: linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(31, 41, 55, 0.95) 100%);
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-muted: #9ca3af;
      --border-color: rgba(255, 255, 255, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --message-user: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --message-assistant: rgba(255, 255, 255, 0.1);
      --message-system: rgba(250, 204, 21, 0.2);
      --input-bg: rgba(255, 255, 255, 0.1);
      --button-primary: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --shadow-color: rgba(0, 0, 0, 0.5);
    }
    
    [data-theme="light"] {
      --bg-primary: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 25%, #ddd6fe 50%, #e0e7ff 75%, #c7d2fe 100%);
      --bg-secondary: #ffffff;
      --text-primary: #000000;
      --text-secondary: #111827;
      --text-muted: #374151;
      --border-color: #d1d5db;
      --glass-bg: #ffffff;
      --message-user: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --message-assistant: #f3f4f6;
      --message-system: #fef3c7;
      --input-bg: #ffffff;
      --button-primary: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    
    /* Light mode specific fixes */
    [data-theme="light"] .chat-container {
      background: #ffffff !important;
      border: 2px solid #d1d5db !important;
    }
    
    [data-theme="light"] .glass-morphism {
      background: #ffffff !important;
      border: 1px solid #d1d5db !important;
    }
    
    [data-theme="light"] #message {
      background: #ffffff !important;
      border: 2px solid #d1d5db !important;
      color: #000000 !important;
    }
    
    [data-theme="light"] #message::placeholder {
      color: #6b7280 !important;
    }
    
    [data-theme="light"] .header-gradient {
      background: #f9fafb !important;
      border-bottom: 1px solid #d1d5db !important;
    }
    
    [data-theme="light"] .header-gradient h1,
    [data-theme="light"] .header-gradient p {
      color: #000000 !important;
    }
    
    [data-theme="light"] .feature-button {
      background: #f3f4f6 !important;
      border: 1px solid #d1d5db !important;
      color: #000000 !important;
    }
    
    [data-theme="light"] .feature-button i {
      color: #000000 !important;
    }
    
    [data-theme="light"] #settingsMenu {
      background: #ffffff !important;
      border: 2px solid #d1d5db !important;
    }
    
    [data-theme="light"] #settingsMenu h3,
    [data-theme="light"] #settingsMenu button {
      color: #000000 !important;
    }
    
    [data-theme="light"] .message-bubble {
      border: 1px solid #d1d5db !important;
    }
    
    [data-theme="light"] .bg-white\/10 {
      background: #f3f4f6 !important;
      border: 1px solid #d1d5db !important;
    }
    
    [data-theme="light"] .border-t {
      border-top: 1px solid #d1d5db !important;
    }
    
    [data-theme="light"] .border-t button {
      background: #f3f4f6 !important;
      border: 1px solid #d1d5db !important;
      color: #000000 !important;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: cover;
      color: var(--text-primary);
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .glass-morphism {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      transition: all 0.3s ease;
    }
    
    .chat-container {
      background: var(--bg-secondary);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-color);
      box-shadow: 0 25px 50px -12px var(--shadow-color);
      transition: all 0.3s ease;
    }
    
    .chat-container.minimized {
      height: 60px !important;
      min-height: 60px !important;
      overflow: hidden;
    }
    
    .chat-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw !important;
      height: 100vh !important;
      max-width: none !important;
      border-radius: 0 !important;
      z-index: 9999;
    }
    
    #chat::-webkit-scrollbar {
      width: 6px;
    }
    
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }
    
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .message-bubble {
      animation: slideInUp 0.3s ease-out;
      transition: all 0.2s ease;
    }
    
    .message-bubble:hover {
      transform: translateY(-2px);
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }
    
    .markdown-content p {
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    
    .markdown-content ul, .markdown-content ol {
      list-style: disc;
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .markdown-content li {
      margin-bottom: 0.5rem;
    }
    
    .markdown-content strong {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .markdown-content a {
      color: #60a5fa;
      text-decoration: underline;
      transition: color 0.2s ease;
    }
    
    .markdown-content a:hover {
      color: #93c5fd;
    }
    
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      background: rgba(55, 65, 81, 0.5);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .markdown-content th,
    .markdown-content td {
      border: 1px solid rgba(75, 85, 99, 0.5);
      padding: 0.75rem;
      text-align: left;
    }
    
    .markdown-content th {
      background: rgba(31, 41, 55, 0.8);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .markdown-content td {
      color: var(--text-secondary);
    }
    
    .settings-menu {
      z-index: 50;
    }
    
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    .btn-primary {
      background: var(--button-primary);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .header-gradient {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    [data-theme="light"] .header-gradient {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }
    
    [data-theme="light"] .header-gradient h1,
    [data-theme="light"] .header-gradient p {
      color: #000000 !important;
    }
    
    .floating-shapes {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: -1;
      pointer-events: none;
    }
    
    .shape {
      position: absolute;
      background: rgba(255, 255, 255, 0.1);
      animation: float 20s infinite ease-in-out;
    }
    
    .shape1 {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      top: 20%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .shape2 {
      width: 120px;
      height: 120px;
      border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
      top: 60%;
      right: 10%;
      animation-delay: 5s;
    }
    
    .shape3 {
      width: 100px;
      height: 100px;
      border-radius: 63% 37% 54% 46% / 55% 48% 52% 45%;
      bottom: 20%;
      left: 20%;
      animation-delay: 10s;
    }
    
    @keyframes float {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
        opacity: 0.1;
      }
      25% {
        transform: translateY(-20px) rotate(90deg);
        opacity: 0.2;
      }
      50% {
        transform: translateY(10px) rotate(180deg);
        opacity: 0.1;
      }
      75% {
        transform: translateY(-15px) rotate(270deg);
        opacity: 0.15;
      }
    }
    
    .window-controls {
      display: flex;
      gap: 8px;
    }
    
    .window-control {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .window-control:hover {
      transform: scale(1.1);
    }
    
    .window-control.close {
      background: #ff5f57;
    }
    
    .window-control.minimize {
      background: #ffbd2e;
    }
    
    .window-control.maximize {
      background: #28ca42;
    }
    
    .feature-button {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .feature-button:hover {
      transform: scale(1.05);
    }
    
    .feature-button:active {
      transform: scale(0.95);
    }
    
    [data-theme="light"] .feature-button {
      color: #000000 !important;
    }
    
    [data-theme="light"] .feature-button:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    [data-theme="light"] .feature-button i {
      color: #000000 !important;
    }
    
    /* Do not hide content by default; only when minimized */
    .hidden-content {
      display: block;
    }
    
    .chat-container.minimized .hidden-content {
      display: none !important;
    }
    
    .chat-container.minimized .header-gradient {
      border-bottom: none;
    }
    
    /* Ensure input box visibility */
    #message {
      color: white !important;
      background: rgba(255, 255, 255, 0.2) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      overflow-y: auto;              /* allow scrolling */
      scrollbar-width: none;         /* Firefox: hide scrollbar */
    }
    /* WebKit: hide scrollbar */
    #message::-webkit-scrollbar { display: none; }

    /* Markdown table styling */
    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      border: 1px solid var(--border-color);
      overflow: hidden;
      border-radius: 12px;
    }
    .markdown-content th,
    .markdown-content td {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      text-align: left;
    }
    .markdown-content thead th {
      font-weight: 600;
    }

    /* Light mode: strong contrast for tables */
    [data-theme="light"] .markdown-content table {
      background: #ffffff;
    }
    [data-theme="light"] .markdown-content thead th {
      background: #f3f4f6; /* gray-100 */
      color: #111827; /* near-black */
      border-bottom: 2px solid #d1d5db;
    }
    [data-theme="light"] .markdown-content tbody tr:nth-child(odd) {
      background: #fafafa; /* subtle zebra */
    }
    [data-theme="light"] .markdown-content tbody tr:hover {
      background: #f1f5f9; /* hover highlight */
    }

    /* Dark mode: readable tables */
    [data-theme="dark"] .markdown-content table {
      background: rgba(255,255,255,0.04);
    }
    [data-theme="dark"] .markdown-content thead th {
      background: rgba(255,255,255,0.08);
      color: #ffffff;
      border-bottom: 2px solid rgba(255,255,255,0.15);
    }
    [data-theme="dark"] .markdown-content tbody tr:nth-child(odd) {
      background: rgba(255,255,255,0.03);
    }
    [data-theme="dark"] .markdown-content tbody tr:hover {
      background: rgba(255,255,255,0.06);
    }

    /* Light mode: make assistant (and all bubbles) text dark for readability */
    [data-theme="light"] .message-bubble,
    [data-theme="light"] .message-bubble .markdown-content {
      color: #111827 !important; /* near-black */
    }
    [data-theme="light"] .message-bubble a { color: #1d4ed8 !important; }
    [data-theme="light"] .message-bubble code { color: #111827 !important; }

    .chat-container { display: flex; flex-direction: column; height: 80vh; max-height: 900px; }
    #chat { flex: 1 1 0; overflow-y: auto; min-height: 0; }
    .glass-morphism[style*="position: sticky"] { background: var(--bg-secondary) !important; border-top: 1px solid var(--border-color) !important; box-shadow: 0 -4px 24px 0 rgba(0,0,0,0.13); }

    /* Remove default blue focus outline from chat input and send button, but leave natural caret for textarea */
    #message:focus, .btn-primary:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    [data-theme="light"] .message-bubble.user {
      background: #f6f8fa !important;
      color: #1a1a1a !important;
      border: 1px solid #d1d5db !important;
    }
    /* In <style> -- ensure assistant header label is dark in light mode: */
    [data-theme="light"] .message-bubble .font-semibold.text-purple-300 {
      color: #1a1a1a !important;
    }

    [data-theme="light"] #message {
      /* already present, but enforce */
      color: #000000 !important;
    }
    [data-theme="light"] #message::placeholder {
      color: #6b7280 !important;
    }
    [data-theme="light"] .message-bubble.user .font-semibold.text-blue-200 {
      color: #1a1a1a !important;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative" data-theme="dark">
  <!-- Floating Background Shapes -->
  <div class="floating-shapes">
    <div class="shape shape1"></div>
    <div class="shape shape2"></div>
    <div class="shape shape3"></div>
  </div>

  <!-- Main Chat Container -->
  <div id="chatContainer" class="w-full max-w-4xl chat-container rounded-3xl flex flex-col overflow-hidden relative" style="min-height: 600px;">
    <!-- Header -->
    <div class="header-gradient p-6 relative">
      <div class="flex items-center justify-between">
        <!-- Window Controls -->
        <div class="window-controls">
          <div class="window-control close" onclick="closeWindow()" title="Close"></div>
          <div class="window-control minimize" onclick="minimizeWindow()" title="Minimize"></div>
          <div class="window-control maximize" onclick="toggleFullscreen()" title="Fullscreen"></div>
        </div>
        
        <!-- Logo and Title -->
        <div class="flex items-center gap-4 flex-1 justify-center">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
            <i class="fas fa-robot text-white text-xl" title="NovaKB"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white mb-1">NovaKB</h1>
            <p class="text-xs text-gray-300">Where Intelligence Meets Conversation</p>
          </div>
        </div>
        
        <!-- Feature Buttons -->
        <div class="flex items-center gap-3">
          <!-- Theme Toggle -->
          <button onclick="toggleTheme()" class="feature-button w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all duration-200" title="Toggle Theme">
            <i id="themeIcon" class="fas fa-moon text-white text-sm"></i>
          </button>
          
          <!-- Export Chat -->
          <button onclick="exportChat()" class="feature-button w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all duration-200" title="Export Chat">
            <i class="fas fa-download text-white text-sm"></i>
          </button>
          
          <!-- Settings -->
          <button onclick="toggleSettings()" class="feature-button w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition-all duration-200" title="Settings">
            <i class="fas fa-cog text-white text-sm"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Dropdown -->
    <div id="settingsMenu" class="settings-menu hidden absolute top-20 right-6 w-72 glass-morphism rounded-2xl shadow-2xl overflow-hidden z-50">
      <div class="p-4 border-b border-white/10">
        <h3 class="text-white font-semibold mb-1">Settings</h3>
        <p class="text-gray-400 text-xs">Customize your experience</p>
      </div>
      
      <div class="p-2">
        <button onclick="collapseSettings(); document.getElementById('upload').click()" class="w-full text-left px-4 py-3 text-white hover:bg-white/10 transition-all duration-200 flex items-center gap-3 rounded-xl">
          <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-cloud-upload-alt text-blue-400 text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-medium text-sm">Upload Knowledge Base</div>
            <div class="text-xs text-gray-400">Add PDF, DOC, TXT files</div>
          </div>
          <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        
        <button onclick="clearKB()" class="w-full text-left px-4 py-3 text-white hover:bg-white/10 transition-all duration-200 flex items-center gap-3 rounded-xl">
          <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-trash-alt text-red-400 text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-medium text-sm">Clear Knowledge Base</div>
            <div class="text-xs text-gray-400">Remove all documents</div>
          </div>
          <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
        
        <button onclick="clearChat()" class="w-full text-left px-4 py-3 text-white hover:bg-white/10 transition-all duration-200 flex items-center gap-3 rounded-xl">
          <div class="w-8 h-8 bg-yellow-500/20 rounded-lg flex items-center justify-center">
            <i class="fas fa-broom text-yellow-400 text-sm"></i>
          </div>
          <div class="flex-1">
            <div class="font-medium text-sm">Clear Chat History</div>
            <div class="text-xs text-gray-400">Remove all messages</div>
          </div>
          <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
        </button>
      </div>
    </div>

    <!-- Upload Progress -->
    <div id="uploadProgressWrapper" class="w-full px-6 pt-4 hidden">
      <div class="glass-morphism rounded-full h-3 overflow-hidden">
        <div id="uploadProgressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 w-0 transition-all duration-500 ease-out"></div>
      </div>
      <p class="text-center text-sm text-gray-300 mt-2">Uploading documents...</p>
    </div>

    <!-- Chat Messages Area (make it flex-1, scrollable but never covers input) -->
    <div id="chat" class="flex-1 p-6 overflow-y-auto space-y-4 hidden-content" style="background: var(--bg-secondary); min-height: 0;">
      <div id="emptyState" class="w-full h-full flex flex-col items-center justify-center text-center opacity-90 select-none py-16">
        <div class="w-16 h-16 rounded-2xl flex items-center justify-center mb-4" style="background: rgba(99,102,241,0.12); border: 1px solid var(--border-color);">
          <i class="fas fa-comments text-white text-xl" style="color: var(--text-primary);"></i>
        </div>
        <h2 class="text-lg font-semibold" style="color: var(--text-primary);">Start a conversation</h2>
        <p class="text-sm mt-2" style="color: var(--text-secondary);">Type a message below or try a quick action to begin.</p>
      </div>
    </div>

    <!-- Quick Actions (move above input, but inside container) -->
    <div class="px-6 py-3 border-t border-white/10 hidden-content" style="background: var(--bg-secondary);">
      <div class="flex gap-2 overflow-x-auto">
        <button onclick="sendQuickMessage('Hello, can you help me?')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full text-white text-sm whitespace-nowrap transition-all duration-200">
          <i class="fas fa-rocket mr-2"></i>Get Started
        </button>
        <button onclick="sendQuickMessage('What can you do?')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full text-white text-sm whitespace-nowrap transition-all duration-200">
          <i class="fas fa-question-circle mr-2"></i>Capabilities
        </button>
      </div>
    </div>

    <!-- Input Area [FIXED TO BOTTOM OF CONTAINER, GLASS LOOK] -->
    <div class="p-4 border-t border-white/10 glass-morphism hidden-content" style="position: sticky; bottom: 0; z-index: 2;">
      <div class="flex items-start gap-3">
        <div class="flex-1 relative">
          <textarea
            id="message"
            placeholder="Type your message..."
            rows="1"
            class="w-full bg-white/20 border border-white/30 text-white placeholder-gray-300 rounded-2xl px-6 py-4 focus:outline-none focus:border-blue-400 input-glow transition-all duration-200 resize-none"
            onkeydown="handleInputKeydown(event)"
            oninput="autoResize(this)"
            style="min-height: 56px;"
          ></textarea>
        </div>
        <button
          id="send"
          onclick="sendMessage()"
          class="btn-primary text-white rounded-2xl h-14 px-6 font-semibold transition-all duration-200 flex items-center gap-2 hover:scale-105 whitespace-nowrap"
          style="min-height: 56px; margin-top: 0px; padding-top: 1px; padding-bottom: 1px;"
        >
          <i class="fas fa-paper-plane"></i>
          <span>Send</span>
        </button>
      </div>
      <div class="flex items-center justify-between mt-3">
        <p class="text-xs text-gray-300">
          <i class="fas fa-keyboard mr-1"></i>
          Press Enter to send, Shift+Enter for new line
        </p>
      </div>
    </div>
  </div>

  <input type="file" id="upload" multiple accept=".pdf,.doc,.docx,.txt,.md" style="display: none;" onchange="uploadFiles()" />
  <input type="file" id="fileAttach" accept=".pdf,.doc,.docx,.txt,.md,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileAttach(event)" />
  <script defer>
  const API_URL = 'http://192.168.7.90:8000/chat';
  const chatContainer = document.getElementById('chat');
  const input = document.getElementById('message');
  const sendBtn = document.getElementById('send');
  const chatContainerElement = document.getElementById('chatContainer');
  let messageCount = 0;
  let sessionStartTime = Date.now();
let isMinimized = false;
  let isFullscreen = false;
  let isSending = false;

  function collapseSettings() {
    const menu = document.getElementById('settingsMenu');
    if (menu) menu.classList.add('hidden');
  }

  function showNotice(text) {
    const id = 'system-' + Date.now();
    const notice = appendMessage('system', text, id);
    if (!notice) return;
    notice.classList.add('relative');
    const closeBtn = document.createElement('button');
    closeBtn.setAttribute('aria-label', 'Dismiss');
    closeBtn.innerHTML = '<i class="fas fa-xmark"></i>';
    Object.assign(closeBtn.style, {
      position: 'absolute',
      top: '8px',
      right: '8px',
      background: 'transparent',
      border: 'none',
      cursor: 'pointer',
      opacity: '0.8'
    });
    closeBtn.addEventListener('mouseenter', () => (closeBtn.style.opacity = '1'));
    closeBtn.addEventListener('mouseleave', () => (closeBtn.style.opacity = '0.8'));
    const removeNotice = () => {
      if (notice && notice.parentNode) notice.parentNode.removeChild(notice);
      const empty = document.getElementById('emptyState');
      const anyMessages = chatContainer.querySelector('.message-bubble');
      if (!anyMessages && empty) empty.style.display = 'flex';
    };
    closeBtn.addEventListener('click', removeNotice);
    notice.appendChild(closeBtn);
    setTimeout(removeNotice, 5000);
    return notice;
  }

  // Initialize session timer
  setInterval(updateSessionTime, 1000);

  function toggleSettings() {
    const menu = document.getElementById('settingsMenu');
    menu.classList.toggle('hidden');
  }

  function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    const currentTheme = body.getAttribute('data-theme');
    
    if (currentTheme === 'dark') {
      body.setAttribute('data-theme', 'light');
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
    } else {
      body.setAttribute('data-theme', 'dark');
      themeIcon.classList.remove('fa-sun');
      themeIcon.classList.add('fa-moon');
    }
  }

  function toggleFullscreen() {
    const container = document.getElementById('chatContainer');
    isFullscreen = !isFullscreen;
    
    if (isFullscreen) {
      container.classList.add('fullscreen');
    } else {
      container.classList.remove('fullscreen');
    }
  }

  function minimizeWindow() {
    const container = document.getElementById('chatContainer');
    isMinimized = !isMinimized;
    
    if (isMinimized) {
      container.classList.add('minimized');
    } else {
      container.classList.remove('minimized');
    }
  }

  function closeWindow() {
    if (confirm('Are you sure you want to close the chat?')) {
      window.close();
      // Fallback if window.close() doesn't work
      window.location.href = 'about:blank';
    }
  }

  function exportChat() {
    let chatContent = '';
    document.querySelectorAll('.message-content').forEach(contentElement => {
      if (contentElement && contentElement.textContent) {
        chatContent += contentElement.textContent + '\n\n';
      }
    });
    
    const blob = new Blob([chatContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `nexusai-chat-export-${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    showNotice('Chat exported successfully!');
  }

  function clearChat() {
    if (confirm('Are you sure you want to clear all chat messages?')) {
      collapseSettings();
      chatContainer.innerHTML = '';
      messageCount = 0;
      updateMessageCount();
      const id = 'system-' + Date.now();
      const notice = appendMessage('system', 'Chat history cleared.', id);
      // Make dismissible
      if (notice) {
        notice.classList.add('relative');
        const closeBtn = document.createElement('button');
        closeBtn.setAttribute('aria-label', 'Dismiss');
        closeBtn.innerHTML = '<i class="fas fa-xmark"></i>';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '8px';
        closeBtn.style.right = '8px';
        closeBtn.style.background = 'transparent';
        closeBtn.style.border = 'none';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.opacity = '0.8';
        closeBtn.onmouseenter = () => (closeBtn.style.opacity = '1');
        closeBtn.onmouseleave = () => (closeBtn.style.opacity = '0.8');

        const removeNotice = () => {
          if (notice && notice.parentNode) {
            notice.parentNode.removeChild(notice);
          }
          // If no other messages, show empty state again
          const empty = document.getElementById('emptyState');
          const anyMessages = chatContainer.querySelector('.message-bubble');
          if (!anyMessages && empty) empty.style.display = 'flex';
        };

        closeBtn.addEventListener('click', removeNotice);
        notice.appendChild(closeBtn);

        // Auto-hide after 5 seconds
        setTimeout(removeNotice, 5000);
      }
    }
  }

  // Ensure empty state visible on load (until first message)
  document.addEventListener('DOMContentLoaded', () => {
    const empty = document.getElementById('emptyState');
    if (empty) empty.style.display = 'flex';
  });

  function toggleModelSettings() {
    // Function removed as requested
  }

  function sendQuickMessage(message) {
    input.value = message;
    sendMessage();
  }

  function attachFile() {
    document.getElementById('fileAttach').click();
  }

  function handleFileAttach(event) {
    const files = event.target.files;
    if (files.length > 0) {
      const fileName = files[0].name;
      appendMessage('system', `File "${fileName}" attached. File upload feature coming soon!`, 'system-' + Date.now());
    }
    event.target.value = '';
  }

  function insertEmoji() {
    const emojis = ['ðŸ˜Š', 'ðŸ‘', 'â¤ï¸', 'ðŸŽ‰', 'ðŸ¤”', 'ðŸ’¡', 'ðŸ”¥', 'âœ¨', 'ðŸš€', 'ðŸ’¯'];
    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
    input.value += randomEmoji;
    input.focus();
  }

  function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
  }

  function handleInputKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }

  function updateMessageCount() {
    const counter = document.getElementById('messageCount');
    if (counter) {
      counter.textContent = messageCount;
    }
  }

  function updateSessionTime() {
    const timeElement = document.getElementById('sessionTime');
    if (timeElement) {
      const now = new Date();
      const diff = Math.floor((now - sessionStartTime) / 1000);
      const minutes = Math.floor(diff / 60);
      const seconds = diff % 60;
      timeElement.textContent = `${minutes}m ${seconds}s`;
    }
  }

  async function clearKB() {
    collapseSettings();
    try {
      const res = await fetch('http://192.168.7.90:8000/clear_kb', { method: 'POST' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      showNotice('Knowledge base cleared successfully!');
    } catch (e) {
      showNotice('Failed to clear knowledge base.');
      console.error('clearKB error:', e);
    }
  }

  async function uploadFiles() {
    const files = document.getElementById('upload').files;
    const progressWrapper = document.getElementById('uploadProgressWrapper');
    const progressBar = document.getElementById('uploadProgressBar');
    collapseSettings();
    if (files.length === 0) {
      showNotice('No files selected!');
      return;
    }

    const formData = new FormData();
    for (let f of files) formData.append('files', f);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'http://192.168.7.90:8000/upload', true);

    // Show progress UI
    progressWrapper.classList.remove('hidden');
    progressBar.style.width = '0%';

    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percent + '%';
      }
    };

    xhr.onload = function () {
      // Hide progress smoothly
      progressBar.style.width = '100%';
      setTimeout(() => {
        progressWrapper.classList.add('hidden');
        progressBar.style.width = '0%';
      }, 400);

      if (xhr.status >= 200 && xhr.status < 300) {
        showNotice('Knowledge base uploaded successfully!');
        document.getElementById('upload').value = '';
      } else {
        showNotice('âŒ Failed to upload files');
      }
    };

    xhr.onerror = function () {
      progressWrapper.classList.add('hidden');
      progressBar.style.width = '0%';
      showNotice('âŒ Failed to upload files');
    };

    xhr.send(formData);
    document.getElementById('upload').value = '';
  }

  function appendMessage(role, content, messageId) {
    const div = document.createElement('div');
    const isUser = role === 'user';
    const isAssistant = role === 'assistant';
    const isSystem = role === 'system';
    
    let messageClass = 'message-bubble ';
    let avatarHtml = '';
    let labelHtml = '';
    
    if (isUser) {
      messageClass += 'user bg-gradient-to-r from-blue-600 to-blue-700 text-white ml-auto max-w-[80%]';
      avatarHtml = '<div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-user text-white text-sm"></i></div>';
      labelHtml = '<span class="font-semibold text-blue-200">You</span>';
    } else if (isAssistant) {
      messageClass += 'glass-morphism text-gray-100 mr-auto max-w-[80%]';
      avatarHtml = '<div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-sm"></i></div>';
      labelHtml = '<span class="font-semibold text-purple-300">NovaKB</span>';
    } else {
      messageClass += 'glass-morphism mx-auto max-w-[80%] text-center';
      avatarHtml = '<div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 mx-auto" style="background: rgba(255,255,255,0.15);"><i class="fas fa-info-circle text-white text-sm"></i></div>';
      labelHtml = '<span class="font-semibold" style="color: var(--text-primary);">System</span>';
    }
    
    div.className = messageClass + ' rounded-2xl p-4 shadow-lg';
    
    let parsedContent = content || '';
    if (typeof marked !== 'undefined') {
      parsedContent = marked.parse(content || '');
    }
    const sanitizedContent = typeof DOMPurify !== 'undefined'
      ? DOMPurify.sanitize(parsedContent, { USE_PROFILES: { html: true } })
      : parsedContent;
    
    div.innerHTML = `
      <div class="flex items-start gap-3">
        ${avatarHtml}
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            ${labelHtml}
            <span class="text-xs opacity-70">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
          </div>
          <div class="markdown-content text-sm leading-relaxed" id="${messageId}">${sanitizedContent}</div>
        </div>
      </div>
    `;
    
    // Hide empty state when first real message appears
    const empty = document.getElementById('emptyState');
    if (empty) empty.style.display = 'none';
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Update message count
    if (!isSystem) {
      messageCount++;
      updateMessageCount();
    }
    
    return div;
  }

  function updateMessage(div, content, messageId) {
    let parsedContent = content || '';
    if (typeof marked !== 'undefined') {
      parsedContent = marked.parse(content || '');
    }
    const sanitizedContent = typeof DOMPurify !== 'undefined'
      ? DOMPurify.sanitize(parsedContent, { USE_PROFILES: { html: true } })
      : parsedContent;
    const contentSpan = div.querySelector(`#${messageId}`);
    contentSpan.innerHTML = sanitizedContent;
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  async function sendMessage() {
    if (isSending) return;
    isSending = true;
    const userInput = input.value.trim();
    if (!userInput) { isSending = false; return; }

    // Clear input
    input.value = '';
    autoResize(input);

    // Add user message to chat
    const messageId = Date.now();
    appendMessage('user', userInput, `user-${messageId}`);

    // Single assistant message bubble with embedded typing loader
    let messageDiv = appendMessage(
      'assistant',
      `<div id="assistant-content-${messageId}"></div>
       <div id="assistant-typing-${messageId}" class="typing-indicator mt-2"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`,
      `assistant-${messageId}`
    );
    chatContainer.scrollTop = chatContainer.scrollHeight;

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream',
          'Cache-Control': 'no-cache',
          'Connection': 'keep-alive',
        },
        body: JSON.stringify({ message: userInput })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server response error:', errorText);
        throw new Error(`Server error! Status: ${response.status} - ${response.statusText}. Response: ${errorText}`);
      }
      
      if (!response.body) {
        throw new Error('No response body received from server');
      }
      // Only use one bubble now: messageDiv
      const contentDiv = messageDiv.querySelector(`#assistant-content-${messageId}`);
      const typingDiv = messageDiv.querySelector(`#assistant-typing-${messageId}`);
      const reader = response.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';
let accumulatedContent = '';
let firstTokenReceived = false;

// Debounce config: update DOM at most once every ~80ms
const DEBOUNCE_MS = 80;
let updateTimer = null;
let lastRendered = '';

function scheduleRender() {
  if (updateTimer) return;
  updateTimer = setTimeout(() => {
    updateTimer = null;
    let parsed = (typeof marked !== 'undefined') ? marked.parse(accumulatedContent) : accumulatedContent;
    const sanitized = (typeof DOMPurify !== 'undefined')
      ? DOMPurify.sanitize(parsed, { USE_PROFILES: { html: true } })
      : parsed;
    if (sanitized !== lastRendered) {
      contentDiv.innerHTML = sanitized;
      lastRendered = sanitized;
      requestAnimationFrame(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
    }
  }, DEBOUNCE_MS);
}

try {
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n\n');
    buffer = lines.pop() || '';

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed || trimmed === 'data: [DONE]') continue;

      if (trimmed.startsWith('data: ')) {
        try {
          const jsonStr = trimmed.replace(/^data: /, '').trim();
          if (!jsonStr) continue;
          const data = JSON.parse(jsonStr);
          if (data.content) {
            // Hide typing dots instantly when first chunk arrives
            if (!firstTokenReceived) {
              firstTokenReceived = true;
              if (typingDiv) typingDiv.style.display = 'none';
            }
            accumulatedContent += data.content;
            scheduleRender();
          }
        } catch (e) {
          // ignore parse errors for partial chunks
        }
      }
    }
  }
} finally {
  reader.releaseLock();
  // flush any pending update
  if (updateTimer) {
    clearTimeout(updateTimer);
    updateTimer = null;
  }
  // Final render
  let parsed = (typeof marked !== 'undefined') ? marked.parse(accumulatedContent) : accumulatedContent;
  const sanitized = (typeof DOMPurify !== 'undefined')
    ? DOMPurify.sanitize(parsed, { USE_PROFILES: { html: true } })
    : parsed;
  if (sanitized !== lastRendered) {
    contentDiv.innerHTML = sanitized;
    requestAnimationFrame(() => {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
  }
  if (typingDiv) typingDiv.style.display = 'none';
}

      if (!accumulatedContent) {
        contentDiv.innerHTML = 'No response content received.';
      }
    } catch (err) {
      // On error: remove typing indicator, update chat with error message
      const messageDiv = document.getElementById(`assistant-${messageId}`);
      const contentDiv = messageDiv && messageDiv.querySelector(`#assistant-content-${messageId}`);
      const typingDiv = messageDiv && messageDiv.querySelector(`#assistant-typing-${messageId}`);
      if (typingDiv) typingDiv.style.display = 'none';
      if (contentDiv) contentDiv.innerHTML = 'Error: Could not connect to server.<br/>' + (err.message || 'Unknown error');
      appendMessage('assistant', `Troubleshooting steps:\n1. Make sure the backend server is running\n2. Check the API URL: ${API_URL}\n3. Look for CORS errors in browser console.`, `help-${Date.now()}`);
    }
    isSending = false;
  }

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  
  // Close settings menu when clicking outside
  document.addEventListener('click', (e) => {
    const settingsBtn = document.querySelector('button[onclick="toggleSettings()"]');
    const settingsMenu = document.getElementById('settingsMenu');
    if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
      settingsMenu.classList.add('hidden');
    }
  });

  // Welcome message as dismissible notice (auto-hides in 5s). If it's the only item, empty state will return after it hides.
  setTimeout(() => {
    showNotice('ðŸ‘‹ Welcome to NovaKB! Your intelligent conversation partner is ready. Experience the future of AI chat with themes and smart features!');
  }, 500);
</script>

</body>
</html>
